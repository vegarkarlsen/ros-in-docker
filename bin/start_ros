#!/usr/bin/bash
#vim: filetype=bash

SCRIPT_PATH=$(realpath "$0")
PROJECT_ROOT=$(dirname "$(dirname "$SCRIPT_PATH")")
VERSION_FILE=$PROJECT_ROOT/.ros-version

if [ -z $ROS_DOCKER_DISTRO ]; then

    if [ -f $VERSION_FILE ]; then
        export ROS_DOCKER_DISTRO=$(cat ${PROJECT_ROOT}/.ros-version)
    else
        echo "Error: ROS_DOCKER_DISTRO is not set. Please set it and try again.";
        exit 1;
    fi
fi

if [ ! -f $PROJECT_ROOT/ros-images/$ROS_DOCKER_DISTRO/Dockerfile ]; then
    echo "Did not find dockerfile for $ROS_DOCKER_DISTRO locally.";
    cd $PROJECT_ROOT && make generate-dockerfile;
fi

export UID=$(id -u)
export GID=$(id -g)

# X - Server
export XSOCK=/tmp/.X11-unix

export XAUTH=/tmp/.ros_in_docker.xauth
touch $XAUTH
xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | xauth -f $XAUTH nmerge -

# TODO: this solution does not allow multiple containers to run simultaneously
# echo $ROS_DOCKER_DISTRO > "${PROJECT_ROOT}/.ros-version"

echo "starting container $DOCKER_CONTAINER_NAME"

docker compose -f "${PROJECT_ROOT}/compose.yaml" up --build -d

